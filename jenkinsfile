pipeline {
    agent any

    environment {
        WORKSPACE_DIR = "${env.WORKSPACE}"
        BENCH_DIR = "${env.WORKSPACE}/frappe-bench"
        FRAPPE_BRANCH = "version-14"
        SITE_NAME = "test.localhost"
        DB_ROOT_PASSWORD = "root"
        ADMIN_PASSWORD = "admin"
        PATH = "$HOME/.local/bin:$PATH"
    }

    stages {

        stage('Build') {
            steps {
                sh '''
                echo "üîß Starting Frappe Bench Build..."
                PYTHON_PATH=$(which python3.11)

                # Clean old bench
                if [ -d "$BENCH_DIR" ]; then
                    echo "Removing old bench folder..."
                    rm -rf "$BENCH_DIR"
                fi

                export PIP_DEFAULT_TIMEOUT=120
                pip config set global.timeout 120 || true
                pip config set global.index-url https://pypi.org/simple || true

                echo "Creating new Frappe bench..."
                bench init "$BENCH_DIR" --frappe-branch $FRAPPE_BRANCH --python $PYTHON_PATH
                '''
            }
        }

        stage('Test') {
            steps {
                sh '''
                echo "üß™ Running build and migration..."
                export PATH=$HOME/.local/bin:$PATH
                cd $BENCH_DIR

                if [ ! -d "sites/$SITE_NAME" ]; then
                    echo "Creating new site..."
                    bench new-site $SITE_NAME --mariadb-root-password $DB_ROOT_PASSWORD --admin-password $ADMIN_PASSWORD --non-interactive
                fi

                bench build
                bench --site $SITE_NAME migrate
                '''
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                echo "üöÄ Deploying Frappe instance..."
                export PATH=$HOME/.local/bin:$PATH
                cd $BENCH_DIR
                bench restart
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ CI/CD pipeline completed successfully!'
        }
        failure {
            echo '‚ùå CI/CD pipeline failed. Check console output for details.'
        }
    }
}

               
