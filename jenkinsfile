 pipeline {
    agent any

    stages {
        stage('Setup Bench Environment') {
            steps {
                sh '''
                echo "Installing Frappe Bench dependencies..."
                sudo dnf update -y
                sudo dnf install -y epel-release
                sudo dnf install -y python3-pip python3-virtualenv nodejs npm redis mariadb-server xorg-x11-server-Xvfb fontconfig

                # Install wkhtmltopdf manually (already downloaded or downloaded automatically)
                if [ ! -f "${WORKSPACE}/wkhtmltox-0.12.6.1-2.almalinux9.x86_64.rpm" ]; then
                    wget -O ${WORKSPACE}/wkhtmltox-0.12.6.1-2.almalinux9.x86_64.rpm https://github.com/wkhtmltopdf/packaging/releases/download/0.12.6.1-2/wkhtmltox-0.12.6.1-2.almalinux9.x86_64.rpm
                fi
                sudo dnf localinstall -y ${WORKSPACE}/wkhtmltox-0.12.6.1-2.almalinux9.x86_64.rpm
                wkhtmltopdf --version

                sudo systemctl enable mariadb
                sudo systemctl start mariadb
                sudo systemctl enable redis
                sudo systemctl start redis

                pip3 install frappe-bench
                bench --version
                '''
            }
        }

        stage('Initialize Bench') {
            steps {
                sh '''
                cd ${WORKSPACE}
                if [ ! -d "frappe-bench" ]; then
                    echo "Creating new frappe bench..."
                    bench init frappe-bench --frappe-branch version-14 --python python3
                else
                    echo "Bench already exists."
                fi
                '''
            }
        }

        stage('Copy App to Bench') {
            steps {
                sh '''
                cd ${WORKSPACE}/frappe-bench/apps
                cp -r ${WORKSPACE}/your_app_name .
                '''
            }
        }

        stage('Setup Site and Install App') {
            steps {
                sh '''
                cd ${WORKSPACE}/frappe-bench
                bench new-site test.localhost --mariadb-root-password root --admin-password admin
                bench --site test.localhost install-app your_app_name
                '''
            }
        }

        stage('Build and Migrate') {
            steps {
                sh '''
                cd ${WORKSPACE}/frappe-bench
                bench build
                bench migrate
                '''
            }
        }

        stage('Restart Bench') {
            steps {
                sh '''
                cd ${WORKSPACE}/frappe-bench
                bench restart
                '''
            }
        }
    }

    post {
        success {
            echo '✅ Build succeeded!'
        }
        failure {
            echo '❌ Build failed! Check console logs for details.'
        }
    }
}
