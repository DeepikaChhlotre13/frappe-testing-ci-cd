pipeline {
    agent any

    environment {
        BENCH_DIR = "/home/jenkins/frappe-bench"
        SITE_NAME = "new.local"
        PYTHON_PATH = "/usr/bin/python3.11" // update as per your server
        BENCH_CMD = "/home/jenkins/.local/bin/bench"
        PATH = "/usr/local/bin:${env.PATH}"
    }

    stages {
        stage('Clone Repository') {
            steps {
                echo "üîÑ Cloning repository..."
                git branch: 'develop', url: 'https://github.com/DeepikaChhlotre13/frappe-testing-ci-cd.git'
            }
        }

        stage('Initialize Bench') {
            steps {
                sh '''
                echo "üì¶ Setting up Frappe bench..."
                if [ ! -d "$BENCH_DIR" ]; then
                    $PYTHON_PATH -m venv ~/frappe-env
                    source ~/frappe-env/bin/activate
                    pip install --upgrade pip
                    pip install frappe-bench
                    $BENCH_CMD init frappe-bench --frappe-branch develop --python $PYTHON_PATH
                fi
                '''
            }
        }

        stage('Get Latest Code & Build') {
            steps {
                sh '''
                echo "üìÇ Copying app to bench apps..."
                cp -r $(pwd) $BENCH_DIR/apps/
                
                cd $BENCH_DIR
                echo "üõ† Installing app..."
                $BENCH_CMD get-app frappe $BENCH_DIR/apps/frappe
                $BENCH_CMD --site $SITE_NAME install-app frappe
                echo "üîß Building assets..."
                $BENCH_CMD build
                '''
            }
        }

        stage('Database Migration') {
            steps {
                sh '''
                echo "üóÑ Migrating database..."
                cd $BENCH_DIR
                $BENCH_CMD --site $SITE_NAME migrate
                '''
            }
        }

        stage('Run Tests') {
            steps {
                sh '''
                echo "‚úÖ Running tests..."
                cd $BENCH_DIR
                $BENCH_CMD --site $SITE_NAME run-tests
                '''
            }
        }

        stage('Restart Bench') {
            steps {
                sh '''
                echo "üîÑ Restarting bench..."
                cd $BENCH_DIR
                $BENCH_CMD restart
                '''
            }
        }
    }

    post {
        success {
            echo "üéâ CI/CD pipeline executed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs."
        }
    }
}

