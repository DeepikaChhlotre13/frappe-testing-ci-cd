pipeline {
    agent any

    environment {
        FRAPPE_BRANCH = "version-14"
        SITE_NAME = "site1.local"
        APP_NAME = "deepika"
        BENCH_DIR = "${env.WORKSPACE}/frappe-bench"
    }

    stages {

        stage('Checkout Repository') {
            steps {
                echo "Cloning repository..."
                checkout scm
            }
        }

        stage('Setup Bench Environment') {
            steps {
                sh '''
                cd ${WORKSPACE}

                # If bench folder doesn't exist, create it
                if [ ! -d "${BENCH_DIR}" ]; then
                    echo "Creating new frappe bench..."
                    bench init frappe-bench --frappe-branch ${FRAPPE_BRANCH} --python python3
                fi

                cd ${BENCH_DIR}
                bench --version
                '''
            }
        }

        stage('Copy App to Bench') {
            steps {
                sh '''
                echo "Copying frappe app to bench..."
                cd ${BENCH_DIR}
                rm -rf apps/${APP_NAME} || true
                cp -r ${WORKSPACE}/${APP_NAME} apps/${APP_NAME}
                '''
            }
        }

        stage('Setup Site and Install App') {
            steps {
                sh '''
                cd ${BENCH_DIR}

                # Create site if not exists
                if ! bench --site ${SITE_NAME} version >/dev/null 2>&1; then
                    echo "Creating new site..."
                    bench new-site ${SITE_NAME} --mariadb-root-password root --admin-password admin --no-mariadb-socket
                fi

                # Install app on site
                bench --site ${SITE_NAME} install-app ${APP_NAME} || true
                '''
            }
        }

        stage('Build and Migrate') {
            steps {
                sh '''
                cd ${BENCH_DIR}
                echo "Building assets and migrating..."
                bench build
                bench --site ${SITE_NAME} migrate
                '''
            }
        }

        stage('Restart Bench') {
            steps {
                sh '''
                cd ${BENCH_DIR}
                echo "Restarting bench..."
                bench restart
                '''
            }
        }
    }

    post {
        success {
            echo "✅ Frappe app deployed successfully!"
        }
        failure {
            echo "❌ Build failed! Check console logs for details."
        }
    }
}
