 pipeline {
    agent any

    environment {
        WORKSPACE_DIR = "${env.WORKSPACE}"
        BENCH_DIR = "${env.WORKSPACE}/frappe-bench"
        APP_GIT = "https://github.com/YourUsername/your_app_name.git" // Replace with your Git repo
        APP_NAME = "your_app_name" // Replace with your app folder name
        FRAPPE_BRANCH = "version-14"
        SITE_NAME = "test.localhost"
        DB_ROOT_PASSWORD = "root"
        ADMIN_PASSWORD = "admin"
        PATH = "$HOME/.local/bin:$PATH" // Ensure bench CLI is in PATH
    }

    stages {

        stage('Install System Dependencies') {
            steps {
                sh '''
                echo "Updating system and installing dependencies..."
                sudo dnf update -y
                sudo dnf install -y epel-release
                sudo dnf install -y python3-pip python3-virtualenv nodejs npm redis mariadb-server xorg-x11-server-Xvfb fontconfig git wget

                sudo systemctl enable mariadb redis
                sudo systemctl start mariadb redis
                '''
            }
        }

        stage('Install wkhtmltopdf') {
            steps {
                sh '''
                WKHTML_VERSION="0.12.6.1-2"
                WKHTML_RPM="${WORKSPACE_DIR}/wkhtmltox-${WKHTML_VERSION}.almalinux9.x86_64.rpm"

                if [ ! -f "$WKHTML_RPM" ]; then
                    echo "Downloading wkhtmltopdf..."
                    wget -O "$WKHTML_RPM" "https://github.com/wkhtmltopdf/packaging/releases/download/${WKHTML_VERSION}/wkhtmltox-${WKHTML_VERSION}.almalinux9.x86_64.rpm"
                fi

                sudo dnf localinstall -y "$WKHTML_RPM"
                wkhtmltopdf --version
                '''
            }
        }

        stage('Install Bench CLI') {
            steps {
                sh '''
                pip3 install --upgrade --user frappe-bench
                export PATH=$HOME/.local/bin:$PATH
                bench --version
                '''
            }
        }

        stage('Initialize Bench') {
            steps {
                sh '''
                export PATH=$HOME/.local/bin:$PATH
                if [ ! -d "$BENCH_DIR" ]; then
                    echo "Creating new Frappe bench..."
                    bench init "$BENCH_DIR" --frappe-branch $FRAPPE_BRANCH --python python3
                else
                    echo "Bench already exists."
                fi
                '''
            }
        }

        stage('Clone App from Git') {
            steps {
                sh '''
                cd $BENCH_DIR/apps
                if [ ! -d "$APP_NAME" ]; then
                    echo "Cloning app from Git..."
                    git clone $APP_GIT
                else
                    echo "App already exists, pulling latest..."
                    cd $APP_NAME && git pull
                fi
                '''
            }
        }

        stage('Setup Site') {
            steps {
                sh '''
                export PATH=$HOME/.local/bin:$PATH
                cd $BENCH_DIR
                if [ ! -d "sites/$SITE_NAME" ]; then
                    echo "Creating new site..."
                    bench new-site $SITE_NAME --mariadb-root-password $DB_ROOT_PASSWORD --admin-password $ADMIN_PASSWORD --non-interactive
                else
                    echo "Site already exists."
                fi
                '''
            }
        }

        stage('Install App on Site') {
            steps {
                sh '''
                export PATH=$HOME/.local/bin:$PATH
                cd $BENCH_DIR
                bench --site $SITE_NAME install-app $APP_NAME
                '''
            }
        }

        stage('Build and Migrate') {
            steps {
                sh '''
                export PATH=$HOME/.local/bin:$PATH
                cd $BENCH_DIR
                bench build
                bench --site $SITE_NAME migrate
                '''
            }
        }

        stage('Restart Bench') {
            steps {
                sh '''
                export PATH=$HOME/.local/bin:$PATH
                cd $BENCH_DIR
                bench restart
                '''
            }
        }

    }

    post {
        success {
            echo '✅ CI/CD pipeline completed successfully!'
        }
        failure {
            echo '❌ CI/CD pipeline failed. Check console output for details.'
        }
    }
}
